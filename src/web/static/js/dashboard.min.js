function addLayersToChart(a){var b=L.tileLayer.wms("http://shelter-database.org:8080/geoserver/shelters/wms",{layers:"shelters:redcross",transparent:!0,opacity:.5}),c=L.tileLayer.wms("http://shelter-database.org:8080/geoserver/shelters/wms",{layers:"shelters:koeppen-geiger",transparent:!0,opacity:.5}),d=L.tileLayer("http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",{layers:"Satellite",transparant:!0,opacity:.5,maxZoom:20,subdomains:["mt0","mt1","mt2","mt3"]}),e={color:"black",weight:1,opacity:.65,fillColor:"white"},f=new L.GeoJSON.AJAX("/static/data/countries.geojson",{style:e}),g={"Climate simplified classification":b,"Koeppen-Geiger":c,"Google Satellite":d,"Country borders":f};a._doRender();var h=a.map(),i=new L.Control.Legend({position:"topleft",collapsed:!0,controlButton:{title:"Legend"}});h.addControl(i),$(".legend-container").append($("#legend")),$(".legend-toggle").append("<i class='legend-icon fa fa-info fa-2x' style='color: #000'></i>"),h.addLayer(b),L.control.layers(null,g).addTo(h)}$(document).ready(function(){function a(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b="[\\?&#]"+a+"=([^&#]*)",c=new RegExp(b),d=c.exec(window.location.hash);return null==d?"":decodeURIComponent(d[1].replace(/\+/g," "))}function k(){var a=[{name:"zone",value:b.filters()},{name:"crisis",value:c.filters()},{name:"climate",value:d.filters()},{name:"time",value:e.filters()},{name:"country",value:f.filters()},{name:"query",value:$("#query").val()}],g=$.param(a);location.hash=g}$("#query").val(a("query"));var b=dc.pieChart("#chart-ring-zone"),c=dc.pieChart("#chart-ring-crisis"),d=dc.pieChart("#chart-ring-climate"),e=dc.barChart("#chart-timeline"),f=dc.rowChart("#chart-bar-country"),g=dc_leaflet.markerChart("#chart-map"),h=dc.rowChart("#chart-topography"),i=dc.dataTable("#shelters-table"),j={zoneFilter:{chart:b,dbName:"zone"},disasterFilter:{chart:c,dbName:"associateddisasterimmediatecause"},climateFilter:{chart:d,dbName:"climatezone"},commercialFilter:{dbName:"typeofimplementingagency"},soilFilter:{dbName:"soiltype"},shelterTypeFilter:{dbName:"typeofshelter"},countryFilter:{chart:f,dbName:"country"},topographyFilter:{chart:h,dbName:"topography"},timeFilter:{chart:e,dbName:"yearofconstructionfirstcompletedshelters"},positionFilter:{},costRange:{dbName:"constructioncostperunitusd",sliderId:"costSlider"},widthRange:{dbName:"widthm",sliderId:"widthSlider"},lengthRange:{dbName:"lengthm",sliderId:"lenghtSlider"},queryFilter:{dbName:"db_id"}};d3.json("api/v0.1.1/shelters",function(a){function p(){for(var a in j){var b=document.getElementById(a);b&&$(b).is("select")&&!function(a,b){d3.json("api/v0.1.1/attributes/"+encodeURI(a),function(c){if(c&&c[a])for(var d=c[a].split(";"),e=0;e<d.length;++e)addOption(b,d[e],d[e])})}(j[a].dbName,b)}for(var a in j){var c=document.getElementById(a);$(c).is("input")&&"range"==$(c).attr("data-type")&&!function(a){var b=j[a].dbName;d3.json("api/v0.1.1/attributes/"+encodeURI(b),function(c){if(c&&c[b]){for(var d=c[b].split(";"),e=0;e<d.length;e++)d[e]=parseInt(d[e],10);var f=Math.min.apply(null,d),g=Math.max.apply(null,d);$("#"+a+"MinValue").text(f),$("#"+a+"MaxValue").text(g),j[a].slider=new Slider("#"+a,{min:f,max:g,id:j[a].sliderId}).on("change",function(b){x(a,b.newValue)}),j[a].maxValue=g}})}(a)}}function v(){function h(a){""!=g[a]&&w(g[a])}function i(a,b){if(""==g[b])a.filter(null);else{var c=g[b].split(",");switch(b){case 4:if(a.filter(null),2==c.length){c[f]=new Date(c[f]);var d=new Date(c[0]),e=new Date(c[1]);a.filter(dc.filters.RangedFilter(d,e))}break;case 7:break;default:for(var f=0;f<c.length;f++)a.filter(c[f])}}}var a=/^#zone=([A-Za-z0-9,_\-\/\s]*)&crisis=([A-Za-z0-9,_\-\/\s]*)&climate=([A-Za-z0-9,_\-\/\s]*)&time=([A-Za-z0-9,_\-\/\s\(\):+]*)&country=([A-Za-z0-9,_\-\/\s]*)&query=([A-Za-z0-9,_\-\/\s]*)$/,g=a.exec(decodeURIComponent(location.hash.replace(/\+/g," ")));g&&(i(b,1),i(c,2),i(d,3),i(e,4),i(f,5),h(6))}function x(a,b){j[a].dimension.filter(b),z()}function y(a){k(),generateShelterList(r.top(1/0));var b="";a.filters().length>0&&(b=a.filters()[a.filters().length-1]);for(var c in j){var d=j[c].chart;d&&d.filters()==a.filters()&&$("#"+c).val(b)}}function z(){dc.renderAll(),generateShelterList(r.top(1/0))}var l=[];for(var m in a){var n=a[m];n.db_id=m,l.push(n)}var o=d3.time.format("%Y");p();var q=crossfilter(l),r=q.dimension(function(a){return a}),s=q.groupAll(),t=dc.dataCount("#data-count");for(var u in j)"timeFilter"==u?(j[u].dimension=q.dimension(function(a){return a.yearofconstructionfirstcompletedshelters?d3.time.year(o.parse(a.yearofconstructionfirstcompletedshelters)):void 0}),j[u].count=j[u].dimension.group().reduceCount(function(a){return a.yearofconstructionfirstcompletedshelters?a.yearofconstructionfirstcompletedshelters:void 0})):"positionFilter"==u?(j[u].dimension=q.dimension(function(a){return a.gpslatitude&&a.gpslongitude?[a.gpslatitude,a.gpslongitude]:void 0}),j[u].count=j[u].dimension.group().reduceCount()):(j[u].dimension=q.dimension(function(a){return a[j[u].dbName]?a[j[u].dbName]:"No data"}),j[u].chart&&(j[u].count=j[u].dimension.group().reduceCount()));g.dimension(j.positionFilter.dimension).group(j.positionFilter.count).center([51.505,-.09]).zoom(2).filterByArea(!0).cluster(!0).on("filtered",y),addLayersToChart(g),g.map().scrollWheelZoom.disable(),b.width(110).height(110).dimension(j.zoneFilter.dimension).group(j.zoneFilter.count).innerRadius(20).on("filtered",y),c.width(110).height(110).dimension(j.disasterFilter.dimension).group(j.disasterFilter.count).innerRadius(20).on("filtered",y),d.width(110).height(110).dimension(j.climateFilter.dimension).group(j.climateFilter.count).innerRadius(20).on("filtered",y),e.width(500).height(120).dimension(j.timeFilter.dimension).group(j.timeFilter.count).barPadding(5).x(d3.time.scale().domain([new Date(2003,1,1),new Date])).xUnits(d3.time.year).on("filtered",y).yAxis().tickFormat(function(a){return d3.format("f")(a)}),f.width(200).height(200).margins({left:0,right:10,top:10,bottom:20}).dimension(j.countryFilter.dimension).group(j.countryFilter.count).on("filtered",y).xAxis().tickFormat(function(a){return d3.format("f")(a)}),f.xAxis().ticks(10),h.width(200).height(200).margins({left:0,right:10,top:10,bottom:20}).dimension(j.topographyFilter.dimension).group(j.topographyFilter.count).on("filtered",y).xAxis().tickFormat(function(a){return d3.format("f")(a)}),i.dimension(r).group(function(a){return""}).columns([function(a){return a.id},function(a){return a.nameofshelter},function(a){return a.zone},function(a){return a.country},function(a){return a.associateddisasterimmediatecause},function(a){return a.climatezone}]).on("renderlet",function(a){a.select("tr.dc-table-group").remove()}),t.dimension(q).group(s),d3.select("#query").on("keydown",function(){if(13==d3.event.keyCode){var a=this.value;console.log("Searching for "+a),w(a)}});var w=function(a){""!=a?d3.json("api/v0.1.1/shelters/search/"+a,function(a){null!=a&&j.queryFilter.dimension.filterFunction(function(b){return b in a}),k(),z()}):(j.queryFilter.dimension.filterAll(),z())};$("select").on("change",function(){if(this.id in j){var a=this.value;j[this.id].chart?(j[this.id].chart.filterAll(),a&&j[this.id].chart.filter(a),dc.redrawAll()):j[this.id].dimension&&(a?j[this.id].dimension.filter(a):(j[this.id].dimension.filterAll(),console.log("no value")),z())}}),d3.select("#all").on("click",function(){for(var a in j)j[a].dimension&&j[a].dimension.filterAll();$("select").val(""),$("#query").val("");for(a in j)j[a].slider&&j[a].slider.setValue([0,j[a].maxValue]);g.map().setZoom(1),z()}),d3.selectAll("#year").on("click",function(){e.filterAll(),dc.redrawAll()}),d3.selectAll("#zone").on("click",function(){b.filterAll(),dc.redrawAll(),$("#zoneFilter").val("")}),d3.selectAll("#crisis").on("click",function(){c.filterAll(),dc.redrawAll(),$("#disasterFilter").val("")}),d3.selectAll("#climate").on("click",function(){d.filterAll(),dc.redrawAll(),$("#climateFilter").val("")}),d3.selectAll("#country").on("click",function(){f.filterAll(),dc.redrawAll(),$("#countryFilter").val("")}),d3.selectAll("#cost").on("click",function(){costChart.filterAll(),dc.redrawAll()}),d3.selectAll("#topography").on("click",function(){h.filterAll(),dc.redrawAll()}),d3.select("#download").on("click",function(){var a=r.top(1/0),b=new Blob([d3.csv.format(a)],{type:"text/csv;charset=utf-8"});saveAs(b,"data.csv")}),v(),z()})}),d3.select("#share").on("click",function(){window.prompt("Link to share:",window.location.href)}),addOption=function(a,b,c){var d=document.createElement("OPTION");d.text=b,d.value=c,a.options.add(d)},generateShelterList=function(a){$("#shelterList").empty();for(var b=0;b<a.length;b++){var c="";if("undefined"!=typeof a[b].shelterpicture&&Object.keys(a[b].shelterpicture).length>0)for(var d in a[b].shelterpicture){c=a[b].shelterpicture[d][0];break}var e=$('<div class="shelter"/>').appendTo("#shelterList");e.append('<div class="image" style="background-image: url(\'/'+c+'\')"></div> <h4 class="title"><a href="/shelter/'+a[b].db_id+'">'+a[b].nameofshelter+'</a></h4><div class="country">'+a[b].country+'</div> <div class="description"><p></p></div>')}};