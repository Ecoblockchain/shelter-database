{% extends "layout.html" %}
{% block head %}
    {{ super() }}
	<script src="{{ url_for('static', filename = 'lib/bower/leaflet/dist/leaflet.js') }}"></script>
	<script src="{{ url_for('static', filename='lib/bower/leaflet-geosearch/src/js/l.control.geosearch.js') }}"></script>
	<script src="{{ url_for('static', filename='lib/bower/leaflet-geosearch/src/js/l.geosearch.provider.google.js') }}"></script>
	<script src="{{ url_for('static', filename='lib/bower/leaflet-geocoder-mapzen/src/leaflet-geocoder-mapzen.js') }}"></script>
	<script src="{{ url_for('static', filename='lib/bower/Leaflet.label/dist/leaflet.label.js') }}"></script>
	<script src="{{ url_for('static', filename='lib/bower/dropzone/dist/dropzone.js') }}"></script>
	<script src="{{ url_for('static', filename='lib/bower/select2/dist/js/select2.full.min.js') }}"></script>
	<script src="{{ url_for('static', filename='js/edit-shelter.js') }}"></script>
	
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='lib/bower/leaflet/dist/leaflet.css') }}" rel="stylesheet" media="screen" />
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='lib/bower/leaflet-geocoder-mapzen/src/leaflet-geocoder-mapzen.css') }}" />
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='lib/bower/Leaflet.label/dist/leaflet.label.css') }}" />
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='lib/bower/dropzone/dist/dropzone.css') }}" />
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='lib/bower/select2/dist/css/select2.min.css') }}" />

{% endblock %}

{% block wrapper_start %}
<div id="wrapper">
{% endblock %}

{% block content %}
        <section class="contribute">
            <div class="content">
                <h1>Add your project</h1>
                <p>The Shelter Database exists because of people like you!<br />We need you to help us build the content</p>
				{% if g.user.is_authenticated %}
                <a id="newShelter" onclick="modalOpen()" class="bt button button-red"><i class="fa fa-plus"></i><span class="text">Add Project</span></a>
				{% else %}
				    <a href="{{ url_for('join') }}" class="bt button button-red"><i class="fa fa-user"></i><span class="text">Please login to add your project</span></a>
				{% endif %}
            </div>
        </section>
        <section class="" style="background-color:#ecf0f1;">
            <div class="content">
                <h3>Why add a project</h3>
                <div class="flexbox">
                    <div class="box">
                        <i class="head fa fa-bank"></i>
                        <h4>Share knowledge</h4>
                        <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
                    </div>
                    <div class="box">
                        <i class="head fa fa-heartbeat"></i>
                        <h4>Save lives</h4>
                        <p>Adding your project will save lives. Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
                    </div>
                </div>
            </div>
        </section>

    <div class="mymodal">
        <div class="content page1" id="modalcontent">
            <div class="page page1">
			    <form class="myform" id="createShelterForm" action="#" method="GET" name="save">
					<div class="mygroup">
						<div class="mylabel">Title of your project:</div>
						<p class="error">This field is required</p>
						<div class="myinput"><input class="required-input" type="text" name="name" placeholder="Name" /></div>
					</div>

					<div class="mygroup">
						<div class="mylabel">Country:</div>
						<p class="error">This field is required</p>
						<label for="countrySelect" class="button button-drop">
							<select id="countrySelect" name="country" data-live-search="true" ></select>
						</label>
					</div>
                
					<!-- <a href="" class="button button-light button-drop button-stretch">Select</a> -->
					<div class="buttons">
						<div onclick="modalClose()" class="button button-light"><i class="fa fa-times"></i><span class="text">Cancel</span></div>
						<!--<button type="submit" id="createShelter" class="btn btn-default form-control" value="Create">Create</button>	-->			                   
					   <div id="createShelter" class="button button-light button-right"><i class="fa fa-arrow-right"></i><span class="text">Next</span></div>
					</div>
				</form>
            </div>
			<form class="myform" id="saveAdditional" action="#" method="GET" name="saveAdditional">

			<div class="page page2">
				<div class="mygroup">
					<div class="mylabel">Who is the implementing organization?</div>
					<p class="error">This field is required</p>

					<select class="organizations" id="2269" property-id="" attribute-id="16" category-id="4" value-id="None" value="" type="text" name="">
					  <option value="-1" selected="selected">Your organization</option>
					</select>
				</div>
                <div class="buttons">
                    <div onclick="modalClose()" class="button button-light"><i class="fa fa-check"></i><span class="text">Cancel</span></div>
                    <div onclick="next()" class="button button-light button-right"><i class="fa fa-arrow-right"></i><span class="text">Next</span></div>
                </div>
            </div>
            <div class="page page3">
				<div class="mygroup">
					<div class="mylabel">What is the year of construction of the first shelters?</div>
					<p class="error">This field is required</p>
					<div class="myinput"><input type="number" name="yearofconstructionfirstshelters" required id="3674" class="free-text-attribute" property-id="" attribute-id="36" category-id="8" value-id="None" value="" placeholder="2016"></div>
				</div>
				<div class="mylabel">Where is the shelter located?</div>
				<div id="locationpicker" style="width:100%; height:250px;">
					<input type="hidden" id="latitude" name="lattitude" required class="free-text-attribute" property-id="" attribute-id="8" category-id="2" value-id="None" value="">
					<input type="hidden" id="longitude" name="longitude" required class="free-text-attribute" property-id="" attribute-id="9" category-id="2" value-id="None" value="">
				</div>

				
                <div class="buttons">
                    <div onclick="modalClose()" class="button button-light"><i class="fa fa-check"></i><span class="text">Cancel</span></div>
                    <div onclick="next()" class="button button-light button-right"><i class="fa fa-arrow-right"></i><span class="text">Next</span></div>
                </div>
            </div>
			<div class="page page4">	
				<div class="mylabel">What type of disaster is the shelter associated with?</div>
				<p class="error">This field is required</p>
				<label for="associatedDisasterSelect" class="button button-drop">
					<select id="associatedDisasterSelect" name="associateddisaster" required class="select-attribute" property-id="" attribute-id="13" category-id="4" id="select13" data-live-search="true">
						  <option value=""></option>
					</select>
				</label>
				
				<div class="mygroup">
					<div class="mylabel">What type of humanitarian response is it?</div>
					<label for="shelterTypeSelect" class="button button-drop">
						<select id="shelterTypeSelect" required class="select-attribute" property-id="" attribute-id="21" category-id="4" id="select21">
							  <option value=""></option>
						</select>
					</label>
				</div>

				<div class="buttons">
                    <div onclick="modalClose()" class="button button-light"><i class="fa fa-check"></i><span class="text">Cancel</span></div>
                    <div onclick="next()" class="button button-light button-right"><i class="fa fa-arrow-right"></i><span class="text">Next</span></div>
                </div>
            </div>
			<!--
            <div class="page page3">
                <div class="mylabel">Location of the Site:</div>
                <div class="options">
                    <div class="option" onclick="optClick(0)" style="background-image: url('{{ url_for('static', filename='img/site/1.png') }}')"></div>
                    <div class="option" onclick="optClick(1)" style="background-image: url('{{ url_for('static', filename='img/site/2.png') }}')"></div>
                    <div class="option" onclick="optClick(2)" style="background-image: url('{{ url_for('static', filename='img/site/3.png') }}')"></div>
                    <div class="option" onclick="optClick(3)" style="background-image: url('{{ url_for('static', filename='img/site/4.png') }}')"></div>
                    <div class="option" onclick="optClick(4)" style="background-image: url('{{ url_for('static', filename='img/site/5.png') }}')"></div>
                    <div class="option" onclick="optClick(5)" style="background-image: url('{{ url_for('static', filename='img/site/6.png') }}')"></div>
                    <div class="option" onclick="optClick(6)" style="background-image: url('{{ url_for('static', filename='img/site/7.png') }}')"></div>
                    <div class="option" onclick="optClick(7)" style="background-image: url('{{ url_for('static', filename='img/site/8.png') }}')"></div>
                </div>

                <div class="buttons">
                    <div onclick="modalClose()" class="button button-light"><i class="fa fa-check"></i><span class="text">Cancel</span></div>
                    <div onclick="next()" class="button button-light right"><i class="fa fa-arrow-right"></i><span class="text">Next</span></div>
                </div>
            </div>
			-->
			</form>
            
			<div class="page page5">
				<div class="mygroup">
					<div class="mylabel">Upload photos of the shelter</div>
					<p class="error">This field is required</p>
					<div id="uploader">
					   <div class="dz-default dz-message"><span>Drop files here to upload</span></div>
					   <div class="fallback">
						   <input id="files" multiple="true" name="files" type="file">
						</div>
					</div>
				</div>
			
				<div class="buttons">
                    <div onclick="modalClose()" class="button button-light"><i class="fa fa-check"></i><span class="text">Cancel</span></div>
                    <div onclick="next()" class="button button-light button-right"><i class="fa fa-arrow-right"></i><span class="text">Next</span></div>
                </div>
                
            </div>
			<div class="page page6">
				<div class="mygroup">
					<div class="mylabel">What is the unit cost of the shelter (USD)?</div>
					<p class="error">This field is required</p>
					<div class="myinput"><input type="number" required class="free-text-attribute" id="2486" property-id="" attribute-id="49" category-id="8" value-id="None" value=""></div>
				</div>
				
				<div class="mygroup">
					<div class="mylabel">What is the number of inhabitants of the shelter?</div>
					<p class="error">This field is required</p>
					<div class="myinput"><input type="number" required min="1" max="200" class="free-text-attribute" id="1996" property-id="" attribute-id="37" category-id="8" value-id="None" value=""></div>
			    </div>
				
				<div class="mygroup">
					<div class="mylabel">What is the total surface area in square meters (m2)?</div>	
					<p class="error">This field is required</p>					
					<div class="myinput"><input type="number" required class="free-text-attribute" id="2274" property-id="" attribute-id="45" category-id="8" value-id="None" value=""></div>
				</div>
				<div class="buttons">
                    <div onclick="next()" class="button button-light"><i class="fa fa-check"></i><span class="text">Finish</span></div>
                </div>
            </div>
			
			<div class="page page7">
				<p>Thank you for entering your shelter in the shelter database. Your shelter will be visible in the database after a short review by the administrator.
				We kindly request you to add additional data about your shelter, such as technical documentation and drawings, and different attributes. You can edit your 
				shelter when you log in to the website and go to 'your shelters'.</p>
				<div class="buttons">
                    <div onclick="modalClose()" class="button button-light"><i class="fa fa-check"></i><span class="text">Close</span></div>
                </div>
            </div>
			
			
			
        </div>
    </div>
	
	<script>
		var cleanFilename = function (name) {
		   return name.toLowerCase().replace(/[^\w]/gi, '');
		};
		
		var createDropzone = function(){
	  
			$("div#uploader").dropzone({ url: "/shelter/edit/multi/" + shelter_id + '/General information'});
			  
			Dropzone.options.uploader = {
			  paramName: "file", // The name that will be used to transfer the file
			  uploadMultiple: true,
			  parallelUploads: 1,
			  maxFilesize: 4, // MB
			  acceptedFiles: "image/*",
			  init: function() {
				this.on("sending", function(file, xhr, formData) {
					var name = "shelter_" + shelter_id + "_" + new Date().getTime();
					//formData.append(name, file);
					formData.append('category_id', '2');
					//formData.append('pictures', '0');
				});
				
				this.on("successmultiple", function (files) {
					  alert("All files have uploaded ");
				});
			  }
			};
			
			// add class
			$('div#uploader').addClass('dropzone');
		}
	</script>
	<script>
	    var shelter_id;
		
        $(document).ready(function() {
		
			initiateLocationPicker();
			
            $("#newShelter").click(function(evt) {
                // fetch shelters
				fetchCountries();
				
				//fetch disaster types
				fetchAssociatedDisasters();
				
				//fetch shelter types
				fetchShelterTypes();
            });
			

			$(".organizations").select2({
				  tags: true,
				  createTag: function (params) {
					return {
					  id: params.term,
					  text: params.term,
					  newOption: true
					}
				  },
				  templateResult: function (data) {
					var $result = $("<span></span>");

					$result.text(data.text);

					if (data.newOption) {
					  $result.append(" <em>(new)</em>");
					}

					return $result;
				  },
				  ajax: {
					url: "https://www.humanitarianresponse.info/api/v1.0/organizations?autocomplete[operator]=CONTAINS&fields=label,id",
					dataType: 'json',
					delay: 250,
					data: function (params) {
					  return 'autocomplete[string]=' + params.term; // search term
					},
					processResults: function (data, page) {
					  // parse the results into the format expected by Select2.
					  // since we are using custom formatting functions we do not need to
					  // alter the remote JSON data
					  
					  var keys = Object.keys(data.data);
					  var items = [];
					  for (var j=0; j < keys.length; j++) {
						items.push({
							id: j,
							text: data.data[keys[j]]
						});
					  }
					  
					  return {
						
						results: items
					  };
					},
					cache: true
				  },
				  escapeMarkup: function (markup) { return markup; }, // let our custom formatter work
				  minimumInputLength: 1
					
			}); 
			
            //Attach a submit handler to the form
			$('#createShelter').on( "click", function() {
                // Get some values from elements on the page:
                var $form = $('#createShelterForm');
                var values = {};
                form_complete = true;
                $.each($form.serializeArray(), function(i, field) {
                    if (field.value == '') {
                        form_complete = false;
                    }
                    values[field.name] = field.value;
                });
                url = $form.attr("action");

                if (form_complete) {
                    // Send the data using post
                    name_of_shelter = values["name"]
                    country_value_id = values["country"];
                    country_name = $('#countrySelect option:selected').text()
                    create_shelter(name_of_shelter, country_value_id, country_name, function (success, result){
						if(!success){
							console.log(result);
						} else {
							shelter_id = result;
							
							// create dropzone
							createDropzone();		
							
							// update the map given the country
							updateLocationPicker();
							
							next();
						}
					});
                } else {
                    alert("Please fill all the fields of the form.");
                }
            });
        });
		
		var fetchCountries = function (){
				var filters = [{"name":"name","op":"eq","val":"Country"}];
                $.ajax({
                    type: 'GET',
                    url: '/api/attribute',
                    contentType: "application/json",
                    dataType: "json",
                    data: {"q": JSON.stringify({"filters": filters})},
                    success: function(result) {
                        result.objects[0].associated_values.map(function(country) {
                            $("#countrySelect").append(new Option(country.name, country.id));
                        })
                    },
                    error: function(XMLHttpRequest, textStatus, errorThrown){
                        //alert(errorThrown);
                    }
                }) ;
		};
		
		var fetchAssociatedDisasters = function (){
				var filters = [{"name":"name","op":"eq","val":"Associated disaster / Immediate cause"}];
                $.ajax({
                    type: 'GET',
                    url: '/api/attribute',
                    contentType: "application/json",
                    dataType: "json",
                    data: {"q": JSON.stringify({"filters": filters})},
                    success: function(result) {
                        result.objects[0].associated_values.map(function(disaster) {
                            $("#associatedDisasterSelect").append(new Option(disaster.name, disaster.id));
                        })
                    },
                    error: function(XMLHttpRequest, textStatus, errorThrown){
                        //alert(errorThrown);
                    }
                }) ;
		};
		
		var fetchShelterTypes = function (){
				var filters = [{"name":"name","op":"eq","val":"Type of shelter"}];
                $.ajax({
                    type: 'GET',
                    url: '/api/attribute',
                    contentType: "application/json",
                    dataType: "json",
                    data: {"q": JSON.stringify({"filters": filters})},
                    success: function(result) {
                        result.objects[0].associated_values.map(function(shelter) {
                            $("#shelterTypeSelect").append(new Option(shelter.name, shelter.id));
                        })
                    },
                    error: function(XMLHttpRequest, textStatus, errorThrown){
                        //alert(errorThrown);
                    }
                }) ;
		};
    </script>
	
	<script type="text/javascript">
	
	function findCountry(data, country){
		var countryData = {};
		$.each(data.features, function (key, val) {
			if (val.properties.other_name === country) {
				countryData.lat = val.properties.lat;
				countryData.lon = val.properties.lon;
				countryData.polygon = val;
				
				//if found, break out of loop
				return false;
			}
		});
		
		//return object (or empty object)
		return countryData;
	};
	
	var countries = {};
	var layerGroup, marker, locationpicker, bounds;
	
	function initiateLocationPicker (){
 
		//set encoding
		$.ajaxSetup({
			scriptCharset: "utf-8",
			contentType: "application/json; charset=utf-8"
		});

		//get data from api
		$.getJSON("/static/data/countries.geojson", function(data) {
			// set countries
			countries = data;
						
			// Initiate leaflet map
			locationpicker = L.map('locationpicker');
			
			// Add OSM base layer
			L.tileLayer('http://a.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png').addTo(locationpicker);
			
			// Add Mapzen geocoder 
			L.control.geocoder('search-Us5vhhe').addTo(locationpicker);
			
			// Create group for your layers and add it to the map
			layerGroup = L.layerGroup().addTo(locationpicker);
			
			// add marker
			marker = L.marker([0,0], {draggable:'true'}).bindLabel('This is where I have built this shelter');
			marker.addTo(locationpicker);
			
			// add listeners	
			locationpicker.on('click', function(e) {        
				var location = e.latlng;
				marker.setLatLng(location).update();
				setLocation(e.latlng);
			});	
		});
	};
	
	var updateLocationPicker = function(){
		//Query nomatimim for lat lon for country
		var country = $('#countrySelect option:selected').text();
		
		var countryData = findCountry(countries, country);
			
		if(jQuery.isEmptyObject(countryData)){
		  //country was not found
		  //TODO: handle error
		  return;
		} 
		
		// remove all layers
		layerGroup.clearLayers();
		
		// Add country polygon to map and fit map to bounds
		var countryLayer = L.geoJson(countryData.polygon).addTo(layerGroup);
		
		// listen to clicks on the layer to set the marker
		countryLayer.on('click', function(e) {        
			var location = e.latlng;
			marker.setLatLng(location).update();
			setLocation(e.latlng);
		});	
		
		// set position of marker to centroid of country
		var centroid = {lat: countryData.lat, lng: countryData.lon};
		marker.setLatLng(centroid); 
		
		// Add the location to the database, in case the user doesn't drag the marker
		setLocation(centroid);
		
		marker.on('dragend', function(event){
			var position = event.target.getLatLng();
			setLocation(event.target.getLatLng());
			marker.setLatLng(position,{draggable:'true'}).bindPopup(position).update();
		});
		
		// fit map to bounds of country
		bounds = countryLayer.getBounds();
		//locationpicker.fitBounds(bounds);				
	}
	
	var setLocation = function(latlng){
		$('#latitude').val(latlng.lat).trigger('change');
		$('#longitude').val(latlng.lng).trigger('change');		
	}
	
	// listen when page3 with leaflet map is opened
	$('#modalcontent').on('page3', function(){ 
		locationpicker.fitBounds(bounds);
		locationpicker.invalidateSize();
	});
	</script>
	
	<script type="text/javascript" class="source">
	
		$(document).ready(function() {
			var dateSupported = (function() {
				var el = document.createElement('input'),
					invalidVal = 'foo'; // Any value that is not a date
				el.setAttribute('type','date');
				el.setAttribute('value', invalidVal);
				// A supported browser will modify this if it is a true date field
				return el.value !== invalidVal;
			}());
			if (!dateSupported) {
				$( ".datepicker" ).datepicker({dateFormat: 'dd/mm/yyyy'});
			}
			
			$('.organizations').on("select2:select", function (e) { 
				value_id = $(e.target).attr("value-id");
				var value = e.params.data.text;

				if (value_id != "None") {
					update_free_text_value(value_id, value);
				} else {
					var category_id = $('.organizations').attr("category-id");
					var attribute_id = $('.organizations').attr("attribute-id");
					new_free_text_property(shelter_id, category_id, attribute_id, value, $(e.target));
				}
			});


			$('.select-attribute').change(function(evt) {			
				property_id = $(evt.target).attr("property-id");
				id_of_values = $(evt.target).val();
				if (typeof id_of_values === 'string') {
					tmp = []
					tmp.push(id_of_values)
					id_of_values = tmp
				}

				if (property_id==""){
					category_id = $(evt.target).attr("category-id");
					attribute_id = $(evt.target).attr("attribute-id");
					new_property(shelter_id,
									category_id, attribute_id, id_of_values,
									$(evt.target));
				} else {
					update_property(property_id, id_of_values);
				}
			});

			$('.date-attribute').on("change", function(evt) {
				var dateFormat = /^(\d{4})-(\d{1,2})-(\d{1,2})$/;
				value = $(evt.target).val();
				if(dateFormat.test(value)){
					editFreeTextOrDate(evt);
				}				
			});

			$('.free-text-attribute').change(function(evt) {
				if( $(evt.target).hasClass('required-input') && !$(evt.target).val() ) {
					// add myerror class to parent div
					$(this).parent().parent().addClass('myerror');
				} else {
					// remove myerror class
					$(this).parent().parent().removeClass('myerror');
					// edit attribute
					editFreeTextOrDate(evt);
				}				
			});
			
			var editFreeTextOrDate = function (evt){
				value = $(evt.target).val();
				if ($(evt.target).context.type == "checkbox") {
					if (value == "on" || value == "1") {
						value = "0";
					} else {
						value = "1";
					}
				}
				value_id = $(evt.target).attr("value-id");

				if (value_id != "None") {
					update_free_text_value(value_id, value);
				} else {
					category_id = $(evt.target).attr("category-id");
					attribute_id = $(evt.target).attr("attribute-id");
					new_free_text_property(shelter_id, category_id, attribute_id, value, $(evt.target));
				}
			}
		});
	
	</script>

    <script type="text/javascript">
            var cnt = document.getElementById("modalcontent")
            var wrapper = document.getElementById("wrapper")
            var page = 1
            var modalOpen = function(){
                wrapper.className = "modal-open"
            }
            var modalClose = function(){
                wrapper.className = ""
                page = 1
                cnt.className = "content page1"
            }
            var setPage = function(){
                cnt.className = "content page" + page
				// trigger event that class changed
				$('#modalcontent').trigger('page'+page);
            }
            var next = function(){
                page++
                setPage()
            }
            var prev = function(){
                page--
                setPage()
            }
            var optClick = function(nr){
                var elements = document.getElementsByClassName('option')
                var length = elements.length

                while(length--) {
                    elements[length].className = "option"
                }
                elements[nr].className = "option selected"
            }
    </script>
{% endblock %}

{% block wrapper_end %}
</div>
{% endblock %}
