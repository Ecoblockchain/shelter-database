{% extends "layout.html" %}
{% block head %}
    {{ super() }}
	<script src="{{ url_for('static', filename = 'lib/leaflet/leaflet.js') }}"></script>
	<script src="{{ url_for('static', filename='lib/leaflet-geosearch/src/js/l.control.geosearch.js') }}"></script>
	<script src="{{ url_for('static', filename='lib/leaflet-geosearch/src/js/l.geosearch.provider.google.js') }}"></script>
	<script src="{{ url_for('static', filename='lib/leaflet-geocoder-mapzen/src/leaflet-geocoder-mapzen.js') }}"></script>
	<script src="{{ url_for('static', filename='lib/Leaflet.label/dist/leaflet.label.js') }}"></script>
	<script src="{{ url_for('static', filename='lib/dropzone/dist/dropzone.js') }}"></script>
	<script src="{{ url_for('static', filename='js/edit-shelter.js') }}"></script>
	
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='lib/leaflet/leaflet.css') }}" rel="stylesheet" media="screen" />
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='lib/leaflet-geocoder-mapzen/src/leaflet-geocoder-mapzen.css') }}" />
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='lib/Leaflet.label/dist/leaflet.label.css') }}" />
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='lib/dropzone/dist/dropzone.css') }}" />
{% endblock %}


{% block content %}
        <section class="contribute">
            <div class="content">
                <h1>Add your project</h1>
                <p>The Shelter Database exists because of people like you!<br />We need you to help us build the content</p>
				{% if g.user.is_authenticated %}
                <a id="newShelter" onclick="modalOpen()" class="bt button button-red"><i class="fa fa-plus"></i><span class="text">Add Project</span></a>
				{% else %}
				    <a href="{{ url_for('join') }}" class="bt button button-red"><i class="fa fa-user"></i><span class="text">Please login to add your project</span></a>
				{% endif %}
            </div>
        </section>
        <section class="" style="background-color:#ecf0f1;">
            <div class="content">
                <h3>Why add a project</h3>
                <div class="flexbox">
                    <div class="box">
                        <i class="head fa fa-bank"></i>
                        <h4>Share knowledge</h4>
                        <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
                    </div>
                    <div class="box">
                        <i class="head fa fa-heartbeat"></i>
                        <h4>Save lives</h4>
                        <p>Adding your project will save lives. Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
                    </div>
                </div>
            </div>
        </section>

    <div class="mymodal">
        <div class="content page1" id="modalcontent">
            <div class="page page1">
			    <form id="createShelterForm" action="#" class="navbar-form navbar-left" method="GET" name="save" class="myform">
					<div class="mylabel">Title of your project:</div>
					<div class="myinput"><input type="text" name="name" placeholder="Name" required="required" /></div>
					<div class="mylabel">Country:</div>

                    <label for="f1" class="button button-drop">
                        <select id="countrySelect" name="country" data-live-search="true"></select>
                    </label>
                
					<!-- <a href="" class="button button-light button-drop button-stretch">Select</a> -->
					<div class="buttons">
						<div onclick="modalClose()" class="button button-light"><i class="fa fa-times"></i><span class="text">Cancel</span></div>
						<!--<button type="submit" id="createShelter" class="btn btn-default form-control" value="Create">Create</button>	-->			                   
					   <div id="createShelter" class="button button-light right"><i class="fa fa-arrow-right"></i><span class="text">Next</span></div>
					</div>
				</form>
            </div>
            <div class="page page2">
                <div class="mylabel">Province / District / Region:</div>
                <div class="myinput"><input class="free-text-attribute"
                                                    property-id=""
                                                    attribute-id="6"
                                                    category-id="2"
                                                    value-id=""
                                                    value=""
													type="" 
													name="" 
													placeholder="Province / District / Region.." /></div>
                <div class="mylabel">City / Village:</div>
                <div class="myinput"><input type="" name="" placeholder="City / Village.." /></div>
				
				<div class="mylabel">Place marker on exact position</div>
				<div id="locationpicker" style="width:100%; height:400px;"></div>
				
                <div class="buttons">
                    <div onclick="modalClose()" class="button button-light"><i class="fa fa-check"></i><span class="text">Cancel</span></div>
                    <div onclick="next()" class="button button-light right"><i class="fa fa-arrow-right"></i><span class="text">Next</span></div>
                </div>
            </div>
            <div class="page page3">
                <div class="mylabel">Location of the Site:</div>
                <div class="options">
                    <div class="option" onclick="optClick(0)" style="background-image: url('{{ url_for('static', filename='img/site/1.png') }}')"></div>
                    <div class="option" onclick="optClick(1)" style="background-image: url('{{ url_for('static', filename='img/site/2.png') }}')"></div>
                    <div class="option" onclick="optClick(2)" style="background-image: url('{{ url_for('static', filename='img/site/3.png') }}')"></div>
                    <div class="option" onclick="optClick(3)" style="background-image: url('{{ url_for('static', filename='img/site/4.png') }}')"></div>
                    <div class="option" onclick="optClick(4)" style="background-image: url('{{ url_for('static', filename='img/site/5.png') }}')"></div>
                    <div class="option" onclick="optClick(5)" style="background-image: url('{{ url_for('static', filename='img/site/6.png') }}')"></div>
                    <div class="option" onclick="optClick(6)" style="background-image: url('{{ url_for('static', filename='img/site/7.png') }}')"></div>
                    <div class="option" onclick="optClick(7)" style="background-image: url('{{ url_for('static', filename='img/site/8.png') }}')"></div>
                </div>

                <div class="buttons">
                    <div onclick="modalClose()" class="button button-light"><i class="fa fa-check"></i><span class="text">Cancel</span></div>
                    <div onclick="next()" class="button button-light right"><i class="fa fa-arrow-right"></i><span class="text">Next</span></div>
                </div>
            </div>
            <div class="page page4">
				<div class="mylabel">Upload photos and images of the shelter</div>
                <form action="/file-upload" class="dropzone" id="dropzone"></form>
			
				<div class="buttons">
                    <div onclick="modalClose()" class="button button-light"><i class="fa fa-check"></i><span class="text">Cancel</span></div>
                    <div onclick="next()" class="button button-light right"><i class="fa fa-arrow-right"></i><span class="text">Next</span></div>
                </div>
                
            </div>
			<div class="page page5">
				<div class="mylabel">Climate zone</div>
                <select class="select-attribute show-tick" property-id="" attribute-id="11" category-id="2" id="select11">
                    <option value=""></option>
                    <option value="256">dry moderate</option>
                    <option value="255">dry polar</option>
                    <option value="257">dry tropical</option>
                    <option value="259">moist moderate</option>
                    <option value="258">moist polar</option>
                    <option value="260">moist tropical</option>
                 </select>
			
				<div class="mylabel">Landform</div>
			    <select class="select-attribute show-tick" property-id="" attribute-id="12" category-id="2" id="select12">
                    <option value=""></option>
                    <option value="267">desert </option>
                    <option value="263">hills</option>
                    <option value="261">mountains</option>
                    <option value="265">plain</option>
                    <option value="262">plateaus</option>
                    <option value="266">river delta</option>
                    <option value="264">valley</option>
                </select>
				
                <div class="buttons">
                    <div onclick="modalClose()" class="button button-light"><i class="fa fa-check"></i><span class="text">Finish</span></div>
                </div>
            </div>
        </div>
    </div>
	
	<script>
		var cleanFilename = function (name) {
		   return name.toLowerCase().replace(/[^\w]/gi, '');
		};
	
		Dropzone.options.dropzone = {
		  paramName: "file", // The name that will be used to transfer the file
		  uploadMultiple: true,
		  parallelUploads: 1,
		  maxFilesize: 2, // MB
		  acceptedFiles: "image/*",
		  init: function() {
			this.on("sending", function(file, xhr, formData) {
				var name = "shelter_" + shelter_id + "_" + new Date().getTime();
				formData.append(name, file);
			});
			
			this.on("successmultiple", function (files) {
				  alert("All files have uploaded ");
			});
		  }
		};
	</script>
	<script>
	    var shelter_id;
		
        $(document).ready(function() {
            $("#newShelter").click(function(evt) {
                var filters = [{"name":"name","op":"eq","val":"Country"}];
                $.ajax({
                    type: 'GET',
                    url: '/api/attribute',
                    contentType: "application/json",
                    dataType: "json",
                    data: {"q": JSON.stringify({"filters": filters})},
                    success: function(result) {
                        result.objects[0].associated_values.map(function(country) {
                            $("#countrySelect").append(new Option(country.name, country.id));
                        })
                        $('.selectpicker').selectpicker({style: 'btn-default',
                            size: false});
                    },
                    error: function(XMLHttpRequest, textStatus, errorThrown){
                        //alert(errorThrown);
                    }
                }) ;
            });

            //Attach a submit handler to the form
			$('#createShelter').on( "click", function() {
                // Get some values from elements on the page:
                var $form = $('#createShelterForm');
                var values = {};
                form_complete = true;
                $.each($form.serializeArray(), function(i, field) {
                    if (field.value == '') {
                        form_complete = false;
                    }
                    values[field.name] = field.value;
                });
                url = $form.attr("action");

                if (form_complete) {
                    // Send the data using post
                    name_of_shelter = values["name"]
                    country_value_id = values["country"];
                    country_name = $('#countrySelect option:selected').text()
                    create_shelter(name_of_shelter, country_value_id, country_name, function (success, result){
						if(!success){
							console.log(result);
						} else {
							shelter_id = result;
							
							// initiate_map
							initiateLocationPicker();
						}
					});
                } else {
                    alert("Please fill all the fields of the form.");
                }
            });
        });
    </script>
	
	<script type="text/javascript">
	
	function findCountry(data, country){
		var countryData = {};
		$.each(data.features, function (key, val) {
			if (val.properties.other_name === country) {
				countryData.lat = val.properties.lat;
				countryData.lon = val.properties.lon;
				countryData.polygon = val;
				
				//if found, break out of loop
				return false;
			}
		});
		
		//return object (or empty object)
		return countryData;
	};
	
	function initiateLocationPicker (){
 
		//Query nomatimim for lat lon for country
		var country = $('#countrySelect option:selected').text();
		
		//set encoding
		$.ajaxSetup({
			scriptCharset: "utf-8",
			contentType: "application/json; charset=utf-8"
		});

		//get data from api
		$.getJSON("/static/data/countries.geojson", function(data) {
		
			var countryData = findCountry(data, country);
			
			if(jQuery.isEmptyObject(countryData)){
			  //country was not found
			  //TODO: handle error
			  return;
			} 
			
			// Initiate leaflet map
			var locationpicker = L.map('locationpicker');
			
			// Add OSM base layer
			L.tileLayer('http://a.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png').addTo(locationpicker);
			
			// Add country polygon to map and fit map to bounds
			var countryLayer = L.geoJson(countryData.polygon).addTo(locationpicker);
						
			// Add Mapzen geocoder 
			L.control.geocoder('search-Us5vhhe').addTo(locationpicker);
			
			// add marker position to centroid of country
			var marker = L.marker([countryData.lat, countryData.lon], {draggable:'true'}).bindLabel('This is where I have built this shelter');
			marker.addTo(locationpicker);
			
			marker.on('dragend', function(event){
						var position = event.target.getLatLng();
						console.log(position);
						marker.setLatLng(position,{draggable:'true'}).bindPopup(position).update();
			});
			
			locationpicker.on('click', function(e) {        
				var location = e.latlng;
				marker.setLatLng(location).update();
			});
			
			// go to next modal
			next();	
			
			// fit map to bounds of country
			var bounds = countryLayer.getBounds();
			locationpicker.fitBounds(bounds);

			//redraw map
			locationpicker.invalidateSize();
		});
	};
	</script>
	
	<script type="text/javascript" class="source">
		$(document).ready(function() {
			var dateSupported = (function() {
				var el = document.createElement('input'),
					invalidVal = 'foo'; // Any value that is not a date
				el.setAttribute('type','date');
				el.setAttribute('value', invalidVal);
				// A supported browser will modify this if it is a true date field
				return el.value !== invalidVal;
			}());
			if (!dateSupported) {
				$( ".datepicker" ).datepicker({dateFormat: 'dd/mm/yyyy'});
			}


			$('.select-attribute').change(function(evt) {
				property_id = $(evt.target).attr("property-id");
				id_of_values = $(evt.target).val();
				if (typeof id_of_values === 'string') {
					tmp = []
					tmp.push(id_of_values)
					id_of_values = tmp
				}

				if (property_id==""){
					category_id = $(evt.target).attr("category-id");
					attribute_id = $(evt.target).attr("attribute-id");
					new_property(shelter_id,
									category_id, attribute_id, id_of_values,
									$(evt.target))
				}
			});

			$('.free-text-attribute').change(function(evt) {
				value = $(evt.target).val();
				if ($(evt.target).context.type == "checkbox") {
					if (value == "on" || value == "1") {
						value = "0";
					} else {
						value = "1";
					}
				}
				value_id = $(evt.target).attr("value-id");

				if (value_id != "None") {
					update_free_text_value(value_id, value);
				} else {
					category_id = $(evt.target).attr("category-id");
					attribute_id = $(evt.target).attr("attribute-id");
					new_free_text_property(shelter_id, category_id,
												attribute_id, value, $(evt.target));
				}
			});

			$('.add-value').click(function(evt) {
				attribute_id = $(evt.target).attr('attribute-id');
				$('#addValueDialog').attr('attribute-id', attribute_id);
				$('#addValueDialog').modal({backdrop:'static', keyboard:false});
			})

			$('#add-new-value').click(function(evt) {

				new_value = {
					attribute_id: $('#addValueDialog').attr('attribute-id'),
					name: $('#new-value-input').val()
				}
				$.ajax({
					type: 'POST',
					url: '/api/value',
					contentType: "application/json",
					dataType: "json",
					data: JSON.stringify(new_value),
					success: function (result) {
						$('#select'+attribute_id)
							.append($("<option></option>")
										.attr("value", result.id)
										.text(result.name));
						$('.selectpicker').selectpicker('refresh');
					},
					error: function(XMLHttpRequest, textStatus, errorThrown){
						console.log(errorThrown);
					}
				});
			})
		});
	</script>

    <script type="text/javascript">
        var cnt = document.getElementById("modalcontent")
        var page = 1
        var modalOpen = function(){
            document.body.className = "modal-open"
        }
        var setPage = function(){
            cnt.className = "content page" + page
        }
        var modalClose = function(){
            page = 1
            document.body.className = ""
            cnt.className = "content page1"
        }
        var next = function(){
            page++
            setPage()
        }
        var prev = function(){
            page--
            setPage()
        }
        var optClick = function(nr){
            var elements = document.getElementsByClassName('option')
            var length = elements.length

            while(length--) {
                elements[length].className = "option"
            }
            elements[nr].className = "option selected"
        }
    </script>
{% endblock %}